# A continuación se presentan los archivos creados en el package "services" del proyecto "orders-api".

## 1. Crear clase "CategoriaService.java" en el package "services."

**Código de clase:**

```
package com.devsoft.orders_api.services;

import com.devsoft.orders_api.dto.CategoriaDTO;
import com.devsoft.orders_api.entities.Categoria;
import com.devsoft.orders_api.interfaces.ICategoriaService;
import com.devsoft.orders_api.repository.CategoriaRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
public class CategoriaService implements ICategoriaService {

    @Autowired //Inyectar por dependencia el repositorio
    private CategoriaRepository categoriaRepository; //Esto es un repositorio que maneja las operaciones CRUD de la entidad Categoria

    @Override
    @Transactional(readOnly = true)
    public List<CategoriaDTO> findAll() { // Este método obtiene todas las categorías y las convierte a CategoriaDTO
        return categoriaRepository.findAll().stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());
    }

    // Método para obtener todas una lista de entidades Categoria
    /*public List<Categoria> getAll(){
        return categoriaRepository.findAll();
    }*/

    @Override
    public CategoriaDTO findById(Long id) {
        Categoria categoria = categoriaRepository.findById(id).orElse(null);
        if (categoria == null) return null;
        return convertToDTO(categoria);
    }

    @Override
    public CategoriaDTO save(CategoriaDTO dto) { // Este método guarda una categoría y devuelve un CategoriaDTO
        Categoria catNueva = new Categoria();
        if(dto.getId() == null) {
            //nuevo registro
            catNueva.setNombre(dto.getNombre());
        }else{
            //actualizar registro
            catNueva.setId(dto.getId());
            catNueva.setNombre(dto.getNombre());
        }
        return convertToDTO(categoriaRepository.save(catNueva));
    }

    // Este método busca una categoría por su nombre y devuelve un CategoriaDTO
    @Override
    public CategoriaDTO findByNombre(String nombre) {
        Categoria categoria = categoriaRepository.findByNombre(nombre);
        if (categoria == null) return null;
        return convertToDTO(categoria);
    }

    @Override
    public void delete(Long id) { // Este método elimina una categoría por su ID
        categoriaRepository.deleteById(id);
    }

    // Método privado para convertir una entidad Categoria a CategoriaDTO
    private CategoriaDTO convertToDTO(Categoria categoria) {
        return new CategoriaDTO(categoria.getId(),categoria.getNombre());
    }
}
```

## 2. Crear clase "MenuService.java" en el package "services."

**Código de clase:**

```
package com.devsoft.orders_api.services;

import com.devsoft.orders_api.dto.MenuDTO;
import com.devsoft.orders_api.entities.Categoria;
import com.devsoft.orders_api.entities.Menu;
import com.devsoft.orders_api.interfaces.IMenuService;
import com.devsoft.orders_api.repository.MenuRepository;
import com.devsoft.orders_api.utils.MenuMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.dao.DataAccessException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

@Service
public class MenuService implements IMenuService {
    @Autowired
    private MenuRepository menuRepository;

    //Obtenemos el valor de la propiedad del directorio de images
    @Value("${app.upload.dir}")
    private String uploadDir;

    @Override
    @Transactional(readOnly = true)
    public List<MenuDTO> findAll() {
        return menuRepository.findAll()
                .stream().map(MenuMapper::toDTO).toList();
    }

    // Método para obtener para un objeto MenuDTO por su ID
    @Override
    @Transactional(readOnly = true)
    public MenuDTO findById(Long id) {
        return menuRepository.findById(id)
                .map(MenuMapper::toDTO).orElse(null);
    }

    @Override
    @Transactional(readOnly = true)
    public MenuDTO findByNombre(String nombre) {
        return menuRepository.findByNombre(nombre)
                .map(MenuMapper::toDTO).orElse(null);
    }

    @Override
    // Método para guardar un objeto MenuDTO, ya sea creando uno nuevo o actualizando uno existente
    public MenuDTO save(MenuDTO dto, MultipartFile imageFile) throws IOException {
        Menu menu;
        if (dto.getId() == null) {
            //se está creando un nuevo registro de Menú
            menu = MenuMapper.toEntity(dto);
            String nombreImagen = procesarImagen(imageFile);
            if (nombreImagen != null) {
                menu.setUrlImagen(nombreImagen);
            }
        } else {
            //Se está actualizando un registro existente
            Optional<Menu> menuActual = menuRepository.findById(dto.getId());
            if (menuActual.isEmpty()) {
                return null;
            }
            menu = menuActual.get();
            //seteamos atributos con dto
            menu.setNombre(dto.getNombre());
            menu.setDescripcion(dto.getDescripcion());
            menu.setTipo(dto.getTipo());
            menu.setPrecioUnitario(dto.getPrecioUnitario());
            menu.setCategoria(new Categoria(dto.getCategoriaDTO().getId(),
                    dto.getCategoriaDTO().getNombre()));
            //Si viene una imgaen nueva, eliminar la imagen anterior
            if (imageFile != null && !imageFile.isEmpty()) {
                if (menu.getUrlImagen() != null && !menu.getUrlImagen().isEmpty()) {
                    //obtenemos la ruta completa de la imagen anterior
                    Path rutaAnterior = Paths.get(uploadDir, "menus", menu.getUrlImagen());
                    //eliminamos la imagen anterior
                    Files.deleteIfExists(rutaAnterior);
                }
                String nombreArchivo = procesarImagen(imageFile);
                menu.setUrlImagen(nombreArchivo);
            }
        }
        Menu menuSave = menuRepository.save(menu);
        return MenuMapper.toDTO(menuSave);
    }

    @Override
    public void delete(Long id) {
        Menu menuActual = menuRepository.findById(id).orElse(null);
        try {
            menuRepository.deleteById(id);
            if (menuActual != null && menuActual.getUrlImagen() != null) {
                // Obtenemos la ruta completa de la imagen anterior para eliminarla
                Path rutaAnterior = Paths.get(uploadDir, "menus", menuActual.getUrlImagen());
                Files.deleteIfExists(rutaAnterior);
            }
        } catch (DataAccessException e) {
            System.out.println("Error: " + e.getMessage());
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    private String procesarImagen (MultipartFile imageFile) throws IOException {
        if (imageFile != null && !imageFile.isEmpty()) {
            //le anteponemos un id al nombre original de la imagen}
            // Generamos un nombre único para la imagen
            String nombreArchivo = UUID.randomUUID().toString() + "_" + imageFile.getOriginalFilename();
            Path rutaArchivo = Paths.get(uploadDir, "menus", nombreArchivo);
            // Guardamos la imagen en el directorio especificado
            Files.createDirectories(rutaArchivo.getParent());
            //subimos o reemplazamos la imagen
            Files.copy(imageFile.getInputStream(), rutaArchivo, StandardCopyOption.REPLACE_EXISTING);
            return nombreArchivo;
        }
        return null;
    }
}
```

## 3. Crear clase "OrdenService.java" en el package "services."

**Código de clase:**

```
package com.devsoft.orders_api.services;

import com.devsoft.orders_api.dto.DetalleOrdenDTO;
import com.devsoft.orders_api.dto.OrdenDTO;
import com.devsoft.orders_api.entities.*;
import com.devsoft.orders_api.interfaces.IOrdenService;
import com.devsoft.orders_api.repository.*;
import com.devsoft.orders_api.utils.EstadoOrden;
import com.devsoft.orders_api.utils.OrdenMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.swing.text.html.Option;
import java.time.LocalDate;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

@Service
public class OrdenService implements IOrdenService {
    @Autowired
    private OrdenRepository ordenRepository;
    @Autowired
    private ClienteRepository clienteRepository;
    @Autowired
    private MesaRepository mesaRepository;
    @Autowired
    private UsuarioRepository usuarioRepository;
    @Autowired
    private MenuRepository menuRepository;

    @Override
    @Transactional(readOnly = true)
    public List<OrdenDTO> findAll() {
        return ordenRepository.findAll()
                .stream().map(OrdenMapper::toDTO).toList();
    }

    @Override
    @Transactional(readOnly = true)
    public List<OrdenDTO> findByEstado(EstadoOrden estado) {
        return ordenRepository.findByEstado(estado)
                .stream().map(OrdenMapper::toDTO).toList();
    }

    @Override
    @Transactional(readOnly = true)
    public OrdenDTO findById(Long id) {
        return ordenRepository.findById(id)
                .map(OrdenMapper::toDTO)
                .orElse(null);
    }

    @Override
    @Transactional
    public OrdenDTO registerOrUpdate(OrdenDTO ordenDTO) {
        //validamos referencias de objetos
        Optional<Cliente> clienteOpt = clienteRepository.findById(ordenDTO.getClienteDTO().getId());
        Optional<Mesa> mesaOpt = mesaRepository.findById(ordenDTO.getMesaDTO().getId());
        Optional<Usuario> userOpt = usuarioRepository.findById(ordenDTO.getUsuarioDTO().getId());
        if (clienteOpt.isEmpty() || mesaOpt.isEmpty() || userOpt.isEmpty()
                || ordenDTO.getDetalle() == null || ordenDTO.getDetalle().isEmpty()){
            return null; //gestionar en el controlador
        }
        Orden orden = null; //objeto a persistir
        if (ordenDTO.getId() == null){
            //Lógica para registrar una nueva orden
            orden = new Orden();
            //seteando los atributos
            orden.setFecha(LocalDate.now());
            orden.setHora(LocalTime.now());
            orden.setEstado(EstadoOrden.CREADA);
            orden.setCorrelativo(generarCorrelativo());
            orden.setTotal(ordenDTO.getTotal());
            orden.setDetalleOrden(new ArrayList<>());
        }else{
            //Lógica para actualizar una orden existente
            Optional<Orden> ordenOpt = ordenRepository.findById(ordenDTO.getId());
            if (ordenOpt.isEmpty()){
                return null;
            }
            orden = ordenOpt.get();
            //limpiamos el detalle previo
            orden.getDetalleOrden().clear();
        }
        //seteamos nuevas referencias
        orden.setCliente(clienteOpt.get());
        orden.setMesa(mesaOpt.get());
        orden.setUsuario(userOpt.get());

        //agregando el detalle de la orden
        for (DetalleOrdenDTO detalleDTO : ordenDTO.getDetalle()) {
            Optional<Menu> menuOpt = menuRepository.findById(detalleDTO.getMenuDTO().getId());
            if (menuOpt.isEmpty()) return null;
            Menu menu = menuOpt.get();
            DetalleOrden detalleOrden = new DetalleOrden();
            detalleOrden.setCantidad(detalleDTO.getCantidad());
            detalleOrden.setPrecio(detalleDTO.getPrecio());
            detalleOrden.setSubtotal(detalleDTO.getSubtotal());
            detalleOrden.setMenu(menu);
            detalleOrden.setOrden(orden);
            //agregamos el detalleOrden a la Orden
            orden.getDetalleOrden().add(detalleOrden);
        }
        Orden ordenPersisted = ordenRepository.save(orden);
        return OrdenMapper.toDTO(ordenPersisted);
    }

    @Override
    @Transactional
    public void anular(Long id) {
        Optional ordenOpt = ordenRepository.findById(id);
        if (ordenOpt.isEmpty()) return;
        Orden orden = (Orden) ordenOpt.get();
        orden.setEstado(EstadoOrden.ANULADA);
        ordenRepository.save(orden);
    }

    @Override
    @Transactional
    public OrdenDTO changeState(OrdenDTO dto) {
        Optional ordenOpt = ordenRepository.findById(dto.getId());
        if (ordenOpt.isEmpty()) return null;
        Orden orden = (Orden) ordenOpt.get();
        //cambiamos el estado de la orden
        orden.setEstado(dto.getEstado());
        return OrdenMapper.toDTO(ordenRepository.save(orden));
    }

    //métodos auxiliares
    private String generarCorrelativo() {
        LocalDate currentDate = LocalDate.now();
        String yearMonth = currentDate.format(DateTimeFormatter.ofPattern("yyyyMM"));
        Long maxCorrelativo = ordenRepository.findMaxCorrelativoByYearAndMonth(yearMonth);
        Long nextCorrelativo = (maxCorrelativo != null) ? maxCorrelativo + 1 : 1;
        return yearMonth + String.format("%04d", nextCorrelativo);
    }
}
```

## 4. Crear clase "ClienteService.java" en el package "services."

**Código de clase:**

```
package com.devsoft.orders_api.services;

import com.devsoft.orders_api.dto.ClienteDTO;
import com.devsoft.orders_api.entities.Cliente;
import com.devsoft.orders_api.interfaces.IClienteService;
import com.devsoft.orders_api.repository.ClienteRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
public class ClienteService implements IClienteService {

    @Autowired
    private ClienteRepository clienteRepository;

    @Override
    @Transactional(readOnly = true)
    public List<ClienteDTO> findAll() {
        return clienteRepository.findAll().stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());
    }

    @Override
    @Transactional(readOnly = true)
    public ClienteDTO findById(Long id) {
        Cliente cl = clienteRepository.findById(id).orElse(null);
        if (cl == null) return null;
        return convertToDTO(cl);
    }

    @Override
    @Transactional(readOnly = true)
    public ClienteDTO finByNombre(String nombre) {
        Cliente cl = clienteRepository.findByNombre(nombre);
        if (cl == null) return null;
        return convertToDTO(cl);
    }

    private ClienteDTO convertToDTO(Cliente cl) {
        return new ClienteDTO(cl.getId(),
                cl.getNombre(),
                cl.getDireccion(),
                cl.getTelefono(),
                cl.getEmail(),
                cl.getTipoCliente());
    }
}
```

## 5. Crear clase "MesaService.java" en el package "services."

**Código de clase:**

```
package com.devsoft.orders_api.services;

import com.devsoft.orders_api.dto.MesaDTO;
import com.devsoft.orders_api.entities.Mesa;
import com.devsoft.orders_api.interfaces.IMesaService;
import com.devsoft.orders_api.repository.MesaRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
public class MesaService implements IMesaService {
    @Autowired
    private MesaRepository mesaRepository;

    @Override
    @Transactional(readOnly = true)
    public List<MesaDTO> findAll() {
        return mesaRepository.findAll().stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());
    }

    @Override
    @Transactional(readOnly = true)
    public MesaDTO findById(Long id) {
        Mesa mesa = mesaRepository.findById(id).orElse(null);
        if (mesa == null) return null;
        return convertToDTO(mesa);
    }

    private MesaDTO convertToDTO(Mesa m){
        return new MesaDTO(m.getId(),
                m.getNumero(),
                m.getUbicacion());
    }
}
````

## 6. Crear clase "UsuarioService.java" en el package "services."

**Código de clase:**

````
package com.devsoft.orders_api.services;

import com.devsoft.orders_api.dto.RoleDTO;
import com.devsoft.orders_api.dto.UsuarioDTO;
import com.devsoft.orders_api.entities.Usuario;
import com.devsoft.orders_api.interfaces.IUsuarioService;
import com.devsoft.orders_api.repository.UsuarioRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
public class UsuarioService implements IUsuarioService {

    @Autowired
    private UsuarioRepository usuarioRepository;

    @Override
    @Transactional(readOnly = true)
    public List<UsuarioDTO> findAll() {
        return usuarioRepository.findAll().stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());
    }

    @Override
    @Transactional(readOnly = true)
    public UsuarioDTO findById(Long id) {
        Usuario user = usuarioRepository.findById(id).orElse(null);
        if (user== null) return null;
        return convertToDTO(user);
    }

    private UsuarioDTO convertToDTO(Usuario user){
        return new UsuarioDTO(user.getId(),
                user.getNombre(),
                user.getUsuario(),
                user.isActivo(),
                new RoleDTO(
                        user.getRole().getId(),
                        user.getRole().getNombre()
                ));
    }
}
````
